<!DOCTYPE html>
<!-- saved from url=(0053)https://michaelshaw.github.io/game_talk/game.html#/38 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

    <title>Game development in Scala - Michael Shaw</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="./Game development in Scala - Michael Shaw_files/reveal.min.css">
    <link rel="stylesheet" href="./Game development in Scala - Michael Shaw_files/night.css" id="theme">
    <link rel="stylesheet" href="./Game development in Scala - Michael Shaw_files/zenburn.css" id="theme">
    <style>
    .reveal pre code {
      overflow: none !important;
      max-height: 800px !important;
    }
    div.slide-background {
      background-size: contain !important;
    }
    section.screenshot {
      background-color: transparent !important;
    }

    span.highlight {
      color: #ff7777;
    }



.reveal .slides section .fragment.highlight-none,
.reveal .slides section .fragment.highlight-a {
  opacity: 1;
}
  .reveal .slides section .fragment.highlight-none.visible {
    color: rgb(220, 220, 220);
  }

  .reveal .slides section .fragment.highlight-a.visible {
    color: #ff7777;
  }

    </style>
  </head>

  <body>
    <div class="reveal linear center" data-transition-speed="default" data-background-transition="default">
      <div class="slides" style="width: 960px; height: 700px; zoom: 1;">

        <section class="past" style="top: -101px; display: none;" hidden="">
          <h2>Game development in Scala</h2>
          <p>How functional programming helps me sleep at night</p>
        </section>

        <section class="past" style="top: -160.5px; display: none;" hidden="">
          <h3>Me</h3>
          <ul>
            <li>Michael Shaw</li>
            <li>Scala for 4 years (Scalatra/Akka/Game Dev)</li>
            <li>Ruby on Rails at <a href="http://wearebrandnew.com/">We Are Brand New</a></li>
            <li>10 months in to developing a game in Scala</li>
            <li>Mostly functional brain</li>
          </ul>
        </section>

        <section class="past" style="top: -297.5px; display: none;" hidden="">
          <p>Context</p>
          <p>Problem</p>
          <p>False Starts</p>
          <img src="./Game development in Scala - Michael Shaw_files/carmack.jpg">
          <p>Solution</p>
          <p>Reflection</p>
        </section>

        <section class="past" style="top: -265.5px; display: none;" hidden="">
          <h3>Lich</h3>

          <img style="float:left" src="./Game development in Scala - Michael Shaw_files/lich.overview.2.png" height="280">
          <img style="float:right" src="./Game development in Scala - Michael Shaw_files/lich.overview.png" height="280">

          <ul style="clear:both;">
            <li>Developed from scratch in Scala ... accidentally</li>
            <li>You're a lich raising an undead army in an open &amp; alive world</li>
          </ul>
        </section>


        <section class="past" style="top: -342px; display: none;" hidden="">
          <img src="./Game development in Scala - Michael Shaw_files/blocks.png" style="max-height:85%">
          <p>Lots of voxels</p>
        </section>

        <section class="past" style="top: -350px; display: none;" hidden="">
          <img src="./Game development in Scala - Michael Shaw_files/entities.png" style="max-height:85%">
          <p>Lots of creatures/entities</p>

        </section>

        <section class="screenshots past" data-screenshot-count="2" style="top: -271px; display: none;" hidden="">
          <h3>Architecture</h3>

          <img src="./Game development in Scala - Michael Shaw_files/architecture.png">
        </section><section class="stack past" style="top: 0px; display: none;" data-previous-indexv="0" hidden=""><section class="screenshot" data-background-transition="slide" data-background="screenshots/11.11.03-10.42.01-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/11.11.10-14.57.39-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section></section>

        <section class="past" style="top: -101px; display: none;" hidden="">
          <h2>Problem</h2>
          <p>Lovers of purity prepare your buckets</p>
        </section>

        <section class="past" style="top: -273px; display: none;" hidden="">
          <h3>Your average game loop</h3>

          <pre><code class="scala">

            <span class="keyword">while</span>(running) {
              update(world, <span class="number">0.05</span>)
              render(world)
            }

            <span class="keyword">def</span> update(world:World, delta:Double) {
              <span class="keyword">for</span>(entity &lt;- world.entities) {
                entity.update(world, delta)
              }
            }

            <span class="keyword">def</span> render(world:World) {
              <span class="keyword">for</span>(entity &lt;- world.entities) {
                draw(entity)
              }
            }

          </code></pre>
        </section>

        <section class="past" style="top: -336px; display: none;" hidden="">
          <h3>Everyone's favourite return type</h3>

          <pre><code class="scala">
          <span class="class"><span class="keyword">class</span> <span class="title">Entity</span> {</span>
            <span class="keyword">def</span> update(world:World, delta:Double) : Unit = {
              <span class="comment">// here be dragons</span>
            }
          }
          </code></pre>

          <h4>Who the hell knows what happens in there?</h4>

          <p style="margin-top:30px">Launch missiles?</p>
          <p>Probably not.</p>
          <p style="margin-top:30px">IO?</p>
          <p>Probably not.</p>
          <p style="margin-top:30px">Unrestricted mutation of the game world?</p>
          <p>Yeah :(</p>
        </section>

        <section class="past" style="top: -277.5px; display: none;" hidden="">
          <h3>State</h3>
          <pre><code class="scala">
<span class="class"><span class="keyword">class</span> <span class="title">World</span><span class="params">(val size:Vec2i)</span> {</span>
  <span class="keyword">val</span> blocks = <span class="keyword">new</span> Array[Byte](size.product)
  <span class="keyword">val</span> entities = <span class="keyword">new</span> mutable.HashMap[Int, Entity]()

<span class="class"><span class="keyword">class</span> <span class="title">Entity</span><span class="params">(val position:Vec2i)</span> {</span>
  <span class="keyword">val</span> facing = Vec2i(<span class="number">1</span>, <span class="number">0</span>)
  <span class="keyword">var</span> health = <span class="number">100</span>
  <span class="keyword">var</span> weaponDrawn = <span class="keyword">false</span>
  <span class="keyword">var</span> attacking = <span class="keyword">false</span>
          </code></pre>
          <ul>
            <li>Arrays are fast ... really, really fast</li>
            <li>Performance is a currency to be spent. More creatures, larger worlds</li>
            <li>Immutable datastructures for long running state =&gt; Old gen GC pressure</li>
            <li>We're stuck with mutation of some sort</li>
          
        </ul></section>

        <section class="past" style="top: -350px; display: none;" hidden="">
          <h3>What about Multiplayer?</h3>
          <ul>
            <li>Not wise to develop up front (unless that's your focus)</li>
            <li>Painful to add later</li>
            <li>How do we keep that mutable soup of void functions in sync?</li>
          </ul>
          <img src="./Game development in Scala - Michael Shaw_files/cant_sleep.jpg" height="400" style="margin-top: 40px">
        </section>

        <section class="past" style="top: -219px; display: none;" hidden="">
          <h3>In to the void</h3>
          <ul>
            <li>If you accept the void/unit functions signatures, you're already screwed</li>
            <li style="margin-top: 15px">The type system is not acknowledging our side effects</li>
            <li style="margin-top: 15px">How do we <b>re</b>construct changesets for multiplayer clients:</li>
            <ul>
              <li style="margin-top: 5px">Calculate deltas from retained entity states?</li>
              <li style="margin-top: 5px">Make components record changes during the frame?</li>
              <li style="margin-top: 5px">Write mutations to clients as they happen?</li>
            </ul>
          </ul>
        </section>

        <section class="screenshots past" data-screenshot-count="5" style="top: -335.5px; display: none;" hidden="">
          <h3>An OOP/encapsulation approach</h3>
          <pre><code class="scala">
  <span class="class"><span class="keyword">class</span> <span class="title">ServerWorld</span><span class="params">(val size:Vec2i)</span> <span class="keyword">extends</span> <span class="title">World</span> {</span>

    <span class="keyword">val</span> blocks = <span class="keyword">new</span> Array[Byte](size.product)
    <span class="keyword">val</span> entities = <span class="keyword">new</span> mutable.HashMap[Int, Entity]()

    <span class="keyword">val</span> blockChanges = <span class="keyword">new</span> mutable.Queue[BlockChange]()

    <span class="keyword">def</span> setBlockAt(x:Int, y:Int, blockId:Byte) {
      blocks(blockLocation(x, y)) = blockId

      blockChanges.enqueue(BlockChange(x, y, blockId))
    }
          </code></pre>
          <p><i>Bleh</i></p>

          <ul style="margin-top:30px">
            <li>Technical debt increases linearly with features</li>
            <li>Our types signatures don't acknowledge our side effects</li>
            <li>Having different versions of components is horrid :(</li>
          </ul>
          <p style="font-size:0.7em; margin-top: 20px"><i>SinglePlayerWorld / MultiplayerServerWorld / MultiplayerClientWorld ...</i></p>
        </section><section class="stack past" style="top: 0px; display: none;" data-previous-indexv="0" hidden=""><section class="screenshot" data-background-transition="slide" data-background="screenshots/11.12.21-23.52.25-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/11.12.07-17.49.18-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/11.12.16-19.18.17-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/11.12.17-17.26.17-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/11.11.19-14.21.13-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section></section>

        <section class="past" style="top: -78px; display: none;" hidden="">
          <h2>False Starts</h2>
        </section>

        <section class="skip-background past" style="top: -307.5px; display: none;" hidden="">
          <h3>Break out the Functional Programming</h3>
          <p style="margin-top:30px">If entities can change anything in the world ...</p>
          <h4 style="margin-top:30px">#1 Fold the world through the updating entities</h4>
          <pre><code class="scala">
  <span class="keyword">val</span> updatedWorld = entities.foldLeft(world) { (w, entity) =&gt;
    updateEntity(entity, w) <span class="comment">// &lt;- what the hell</span>
  }

  <span class="keyword">def</span> updateEntity(entity:Entity, world:World) : World
        </code></pre>
          <p style="margin-top:30px">Unrestricted and awkward modification through copying</p>
          <p style="margin-top:30px">Reconstructing delta not solved</p>
          <p style="margin-top:30px">The updateEntity function is horrid</p>
        </section>

        <section class="past" style="top: -287px; display: none;" hidden="">
          <img src="./Game development in Scala - Michael Shaw_files/monads.jpg">
          <p>Disclaimer: I lack the formal qualifications to present the next slide</p>
        </section>

        <section class="past" style="top: -350px; display: none;" hidden="">
          <h4>#2 Monadifying things</h4>
          <p class="small">Too big to copy, let's orchestrate mutation</p>

          <pre><code class="scala">
  <span class="keyword">sealed</span> <span class="class"><span class="keyword">trait</span> <span class="title">WorldMonad</span>[<span class="title">S</span>] {</span> <span class="comment">// state thread s</span>
    <span class="keyword">private</span> <span class="keyword">def</span> blocks : Array[Byte]

    <span class="keyword">def</span> getBlockId(x:Int, y:Int) : ST[S, Byte]
    <span class="keyword">def</span> setBlockId(x:Int, y:Int, b:Byte) : ST[S, WorldMonad[S]]
    <span class="keyword">def</span> getEntity(entityId:Int) : ST[S, Entity]
  }

  <span class="comment">// ST[S, A] is a "state transformer" roughly: S =&gt; (S, A)</span>
  <span class="comment">// transforms state indexed by type S, delivers type A</span>

  <span class="class"><span class="keyword">object</span> <span class="title">WorldMonad</span> {</span>
    <span class="keyword">def</span> apply[S](blocks:Array[Byte]) = <span class="keyword">new</span> WorldMonad[S] {
      <span class="keyword">val</span> blocks = blocks
    } <span class="comment">// called once at the start of game to construct the world</span>
  }

  <span class="keyword">def</span> updateEntity[S](entity:Entity) : WorldMonad[S] =&gt; WorldMonad[S] <span class="comment">// ???</span>
          </code></pre>
          <ul>
            <li style="margin-top:15px">Copying is gone. We have typesafe serial mutation of the world.</li>
            <li style="margin-top:15px">The contents of the monad still share the same problems of the mutable version.</li>
            <li style="margin-top:15px">Maybe functional programming isn't the answer ...</li>
          </ul>
        </section>

        <section class="screenshots past" data-screenshot-count="5" style="top: -81px; display: none;" hidden="">
          <p>... or maybe functional programming can't magically protect you from using poor abstractions and writing bad code</p>
        </section><section class="stack past" style="top: 0px; display: none;" data-previous-indexv="0" hidden=""><section class="screenshot" data-background-transition="slide" data-background="screenshots/12.02.07-21.34.53-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/12.02.25-17.27.33-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/12.06.28-00.00.00-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/12.06.29-23.24.02-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/12.07.06-0.43.24-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section></section>

        <section class="past" style="top: -70.5px; display: none;" hidden="">
          <h3>Solution</h3>
        </section>

        <section class="past" style="top: -350px; display: none;" hidden="">
          <h4>John Carmack</h4>
          <img src="./Game development in Scala - Michael Shaw_files/carmack.sermon.jpg" height="300">
          <p>QuakeCon 2013 (heavily paraphrased)</p>
          <blockquote>"Run all your entities independently in a functionally pure way, pass in a static copy of the world (from last frame) and themselves, and they return a new version of themselves at the end"</blockquote>

          <pre><code class="scala"><span class="keyword">def</span> updateEntity(entity:Entity, world:World) : Entity</code></pre>
          <p style="font-size:0.8em">But Mr. Carmack? How are the entities going to affect change outside of themselves?</p>
        </section>

        <section class="past" style="top: -350px; display: none;" hidden="">
          <img src="./Game development in Scala - Michael Shaw_files/carmack.sermon.2.jpg">
          <blockquote>"You create events that get communicated to the target entities"</blockquote>
          <p>In their simplest form: Entity =&gt; Entity</p>
          <pre><code class="scala">
  <span class="keyword">def</span> takeDamage(damage:Int)(e:Entity) : Entity = {
    e.copy(health = clamp(e.health - damage, <span class="number">0</span>, <span class="number">100</span>))
  } <span class="comment">// partially apply with a damage value to get an "event"</span>
          </code></pre>
          <p>Events are then routed to their target entities which evaluate them on next frame</p>
        </section>

        <section class="stack past" style="top: 0px; display: none;" data-previous-indexv="0" hidden="">
          <section style="top: -350px; display: none;" class="">
            <h3>Let's modify this a little</h3>
            <ul>
              <li>Change the partially applied functions to explicit event classes</li>
              <li>One type per possible side effect</li>
              <li>These events sometimes need to reply with events too</li>
              <pre><code class="scala">
<span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">TakeDamage</span><span class="params">(damage:Int, fromEntityId:Int, toEntityId:Int)</span> <span class="keyword">extends</span> <span class="title">Event</span> {</span>
  <span class="comment">// immutable version</span>
  <span class="keyword">def</span> applyTo(entity:Entity) : (Entity, Seq[Event]) =  {
    (entity.copy(health = clamp(entity.health - damage, <span class="number">0</span>, <span class="number">100</span>)), Seq.empty)
  }

  <span class="comment">// mutable version</span>
  <span class="keyword">def</span> applyTo(entity:Entity) : Seq[Event] {
    entity.health = clamp(entity.health - damage, <span class="number">0</span>, <span class="number">100</span>)
    Seq.empty
  }
              </code></pre>
              <li style="padding-top:15px">90% of our entity logic can remain pure, 10% is a <b>simple</b> set of events that can modify entities</li>
              <li>Immutable vs. Mutable is a trivial set of code changes</li>
            </ul>
            <pre><code class="scala">
    <span class="keyword">def</span> updateEntity(entity:ReadonlyEntity, world:ReadonlyWorld) :
      (Seq[Event], Seq[StateTransition])
              </code></pre>
          </section>
          <section class="future" style="top: -350px; display: none;" hidden="">
            <p>Goblin A hits Goblin B</p>
            <img src="./Game development in Scala - Michael Shaw_files/take.damage.png">
          </section>
        </section>

        <section class="past" style="top: -350px; display: none;" hidden="">
          <h3>Events &amp; Message Passing</h3>
          <p>Game logic is pure functions that emit events</p>
          <pre><code class="scala">
  <span class="keyword">def</span> updateEntity(entity:ReadonlyEntity, world:ReadonlyWorld) :
    (Seq[Event], Seq[StateTransition]) <span class="comment">// 90%</span>

  <span class="comment">// our game loop becomes</span>
  <span class="fragment highlight-a visible" data-fragment-index="0"><span class="fragment highlight-none visible" data-fragment-index="1"><span class="keyword">val</span> eventsToRoute = world.entities.values.flatMap { entity =&gt;</span></span>
    <span class="fragment highlight-a visible" data-fragment-index="2"><span class="fragment highlight-none visible" data-fragment-index="3"><span class="keyword">val</span> replyEvents = entity.events.flatMap { ev =&gt;
      ev.applyTo(entity) <span class="comment">// take damage from others etc.</span>
    }</span></span>
    <span class="fragment highlight-a visible" data-fragment-index="4"><span class="fragment highlight-none visible" data-fragment-index="5"><span class="keyword">val</span> (externalEvents, stateTransitions) = updateEntity(
      entity.asInstanceOf[ReadonlyEntity],
      worldFromLastFrame
    )</span></span>
    <span class="fragment highlight-a visible" data-fragment-index="6"><span class="fragment highlight-none visible" data-fragment-index="7"><span class="keyword">for</span>(t &lt;- stateTransitions) {
      t.applyTo(entity) <span class="comment">// change entity position etc.</span>
    }</span></span>
    <span class="fragment highlight-a visible" data-fragment-index="8"><span class="fragment highlight-none visible" data-fragment-index="9">replyEvents ++ externalEvents</span></span>
  }

  <span class="comment">// route events and repeat </span></code></pre>
          <ul>
            <li>Explicit Side Effects</li>
            <li>Hidden mutation no longer possible, the update functions have nothing they can change</li>
            <li>Having side effects up front is much easier than reconstructing them from the soup later</li>
          </ul>
        </section>

        <section class="past" style="top: -336.5px; display: none;" hidden="">
          <h3>Routing</h3>

          <p>Mutable</p>
          <pre><code class="scala">
  <span class="comment">// send events out between frames</span>
  <span class="keyword">for</span>(event &lt;- eventsToRoute) {
    world.entities(event.toEntityId).events += event
  }

  </code></pre>

<p>Immutable</p>
  <pre><code class="scala">

  <span class="comment">// group the events by toEntityId before the frame</span>
  <span class="keyword">val</span> eventsById = eventsFromLastFrame.groupBy(_.toEntityId).withDefault(Seq.empty)
  <span class="comment">// Map[Int, Seq[Event]]</span>

  <span class="keyword">val</span> eventsToRoute = world.entities.values.flatMap { entity =&gt;
    <span class="keyword">val</span> replyEvents = eventsById(entity.id).flatMap { ev =&gt;
      ev.applyTo(entity)
    }
    <span class="comment">// the rest of the update code</span>

          </code></pre>
        </section>

        <section class="past" style="top: -254px; display: none;" hidden="">
          <h3>Our new game loop</h3>
<pre><code class="scala">
<span class="highlight"><span class="keyword">val</span> eventsById = eventsFromLastFrame.groupBy(_.toEntityId).withDefault(Seq.empty)</span>
<span class="comment">// Map[Int, Seq[Event]]</span>

<span class="keyword">val</span> eventsToRoute = world.entities.flatMap { entity =&gt;
  <span class="keyword">val</span> replyEvents = <span class="highlight">eventsById(entity.id)</span>.flatMap { ev =&gt;
    ev.applyTo(entity) <span class="comment">// take damage from others etc.</span>
  }
  <span class="keyword">val</span> (externalEvents, stateTransitions) = updateEntity(
    entity.asInstanceOf[ReadonlyEntity],
    worldFromLastFrame
  )
  <span class="keyword">for</span>(t &lt;- stateTransitions) {
    t.applyTo(entity) <span class="comment">// change entity position etc.</span>
  }
  replyEvents ++ externalEvents
}

</code></pre>
        </section>

        <section class="screenshots stack past" data-screenshot-count="5" style="top: 0px; display: none;" data-previous-indexv="0" hidden="">
          <section style="top: -187.5px; display: none;" class="">
          <h3>It's all good then right?</h3>
            <ul>
              <li style="margin-top:30px">Effects are serialized in the context of entities, and external side effects occur in the next frame (lag)</li>
              <li style="margin-top:30px">Events that you thought would succeed can now fail</li>
              <li style="margin-top:30px">Two entities trying to pickup an item (also an entity) at the same time</li>
          </ul></section>
          <section class="future" style="top: -350px; display: none;" hidden="">
            <img src="./Game development in Scala - Michael Shaw_files/burger.transfer.png">
          </section>
          <section class="future" style="top: -276.5px; display: none;" hidden="">
            <pre><code class="scala">
    <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">PickupItem</span><span class="params">(toItemId:Int, fromEntityId:Int)</span> <span class="keyword">extends</span> <span class="title">Event</span> {</span>
      <span class="keyword">def</span> applyTo(entity:Entity) : Seq[Event] = {
        <span class="keyword">if</span>(entity.alive) {
          entity.alive = <span class="keyword">false</span>
          Seq(SuccessfulPickup(entity.itemType, fromEntityId))
        } <span class="keyword">else</span> {
          Seq(FailedPickup(entity.itemType, fromEntityId))
        }
      }
    }
      <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">SuccessfulPickup</span><span class="params">(itemType:Int, toEntityId:Int)</span> <span class="keyword">extends</span> <span class="title">Event</span> {</span>
        <span class="keyword">def</span> applyTo(entity:Entity) : Seq[Event] {
          entity.itemInHands = Some(itemType)
          Seq.empty
        }
      }
      <span class="class"><span class="keyword">case</span> <span class="keyword">class</span> <span class="title">FailedPickup</span><span class="params">(itemType:Int, toEntityId:Int)</span> <span class="keyword">extends</span> <span class="title">Event</span></span>
              </code></pre>
            <ul>
              <li>Failure is now an explicit path that must be handled</li>
              <li>Our game now smells like a distributed system</li>
            </ul>
          </section>
        </section><section class="stack past" style="top: 0px; display: none;" data-previous-indexv="0" hidden=""><section class="screenshot" data-background-transition="slide" data-background="screenshots/12.09.06-20.38.21-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/12.12.14-12.51.12-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/12.12.14-15.42.41-ss.PNG" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.01.22-19.03.11-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.02.16-1.53.47-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);" hidden=""></section></section>

        <section class="past" style="top: -81px; display: none;" hidden="">
          <p>This is all great, but I don't recall seeking out purity/correctness or even immutability ...</p>
        </section>

        <section class="past" style="top: -249.5px; display: none;" hidden="">
          <h3>Parallelism (of the embarassing kind)</h3>

          <p>Since mutation is entity local, our game loop can become</p>
           <pre><code class="scala">

<span class="keyword">val</span> eventsToRoute = world.entities<span class="highlight">.par</span>.flatMap { entity =&gt;
  <span class="keyword">val</span> replyEvents = eventsById(entity.id).flatMap { ev =&gt;
    ev.applyTo(entity) <span class="comment">// take damage from others etc.</span>
  }
  <span class="keyword">val</span> (externalEvents, stateTransitions) = updateEntity(
    entity.asInstanceOf[ReadonlyEntity],
    worldFromLastFrame
  )
  <span class="comment">// rest of update code</span>

          </code></pre>

          <p style="font-size: 0.7em">(We added the .par)</p>
        </section>

        <section class="past" style="top: -63px; display: none;" hidden="">
          <p>Performance Shmerformance</p>
        </section>



        <section class="past" style="top: -350px; display: none;" hidden="">
          <h3>Routing Revisited</h3>
          <pre><code class="scala">  <span class="keyword">def</span> updateClientWorld(playerId:Int, world:World, server:MultiPlayerServer) { <span class="fragment highlight-a visible" data-fragment-index="0"><span class="fragment highlight-none visible" data-fragment-index="1">
    <span class="comment">// apply state updates from server</span>
    <span class="keyword">for</span>((id, events) &lt;- server.entityEvents.groupBy(_.toEntityId)) {
      <span class="keyword">val</span> entity = world.entityFor(id)
      <span class="keyword">for</span>(event &lt;- events) {
        event.applyTo(entity)
      }
    }</span></span>

    <span class="comment">// locally simulate our player entity</span>
    <span class="fragment highlight-a visible" data-fragment-index="2"><span class="fragment highlight-none visible" data-fragment-index="3"><span class="keyword">val</span> playerEntity = world.getEntity(playerId)
    <span class="keyword">val</span> replyEvents = server.playerEvents.flatMap { ev =&gt;
      ev.applyTo(playerEntity)
    }

    <span class="keyword">val</span> (externalEvents, stateTransitions) = updateEntity(playerEntity, world)

    <span class="keyword">for</span>(t &lt;- stateTransitions) {
      t.applyTo(entity) <span class="comment">// mutation</span>
    }</span></span>

    <span class="fragment highlight-a visible" data-fragment-index="4"><span class="fragment highlight-none visible" data-fragment-index="5">server.sendEvents(stateTransitions, externalEvents ++ replyEvents)</span></span>
    <span class="comment">// all events must go to the server</span>
  }

          </code></pre>
          <p>Multiplayer/Singleplayer is only a routing change away <br>(with some custom events too)</p>
        </section>

        <section class="past" style="top: -200.5px; display: block;" hidden="">
          <h3>These problems were always there</h3>
          <p style="margin-top:30px">Multiplayer clients can never be certain about the success of actions until sent to the server, serialized and replied to. </p>
          <p style="margin-top:30px">This is the speed of light rearing it's ugly head again.</p>
          <p style="margin-top:30px">In order to support multiplayer later, you need to act like multiplayer now, handle failure &amp; conflict.</p>


        </section>


        <section class="past" style="top: -70.5px; display: block;" hidden="">
          <h3>A little reflection</h3>
        </section>

        <section class="past" style="top: -214.5px; display: block;" hidden="">
          <h3>Benefits of the FP approach</h3>
          <ul>
            <li>Logging/debugging/testing/explicitness/correctness etc. etc.</li>
            <li>Multiplayer/singleplayer is a routing change away</li>
            <li>Game logic remains the same (implement a feature once)</li>
            <li>Our types document things. Expansion of scope requires expansion of events &amp; types</li>
            <li>We're making better use of our compiler</li>
            <li>Purity is enforced through handing our update functions readonly versions of entities/the world</li>
          </ul>
        </section>
        <section class="present" style="top: -249.5px; display: block;">
          <h3>What did I learn here?</h3>
          <ul>
            <li>Carmack is a smart man</li>
            <li>The functional process was important, analyzing side effects and data flow</li>
            <li>Purity can be hugely beneficial</li>
            <li>Both mutable and immutable versions of the code were:</li>
            <ul>
              <li>Terrible when the base abstraction was wrong</li>
              <li>Trivially different with the event model</li>
            </ul>
          </ul>
          <p style="margin-top:60px"><i>Why didn't events seem obvious from the start?</i></p>
        </section>

        <section class="screenshots future" data-screenshot-count="8" hidden="" style="top: -255.5px; display: block;">
          <h3>Generalizing further</h3>
          <p style="margin-top:50px">Sometimes your abstraction can be horribly, horribly wrong.</p>
          <p style="margin-top:50px">This might not be obvious until a better solution is shown to you (Dunning–Kruger applied to code?)</p>
          <p style="margin-top:50px">Events (or anything) aren't going to fit every model</p>
          <p style="margin-top:50px">In my case an FP approach + events was a natural fit</p>
        </section><section hidden="" class="stack future" style="top: 0px; display: block;"><section class="screenshot" data-background-transition="slide" data-background="screenshots/13.03.23-0.49.54-ss.png" style="top: -40px; display: block; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.03.25-11.53.35-ss.png" style="top: -40px; display: block; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.03.26-1.53.53-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.03.27-19.22.56-ss.png" style="top: -40px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.05.01-17.58.18-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.05.30-16.03.40-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.05.29-19.04.26-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);"></section> <section class="screenshot future" data-background-transition="slide" data-background="screenshots/13.09.08-12.48.06-ss.png" style="top: -20px; display: none; background: rgba(255, 255, 255, 0.901961);"></section></section>

        <section hidden="" class="future" style="top: -93.5px; display: block;">
          <p>Thanks for listening</p>
          <p style="margin-top:25px">Slides &amp; example code are on <a href="http://michaelshaw.github.io/">michaelshaw.github.io</a></p>
        </section>
      </div>
    <div class="backgrounds"><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"><div class="slide-background present" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.11.03-10.42.01-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.11.10-14.57.39-ss.png);"></div></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"><div class="slide-background present" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.12.21-23.52.25-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.12.07-17.49.18-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.12.16-19.18.17-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.12.17-17.26.17-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/11.11.19-14.21.13-ss.png);"></div></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"><div class="slide-background present" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.02.07-21.34.53-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.02.25-17.27.33-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.06.28-00.00.00-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.06.29-23.24.02-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.07.06-0.43.24-ss.png);"></div></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"><div class="slide-background present"></div><div class="slide-background future"></div></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"><div class="slide-background present"></div><div class="slide-background future"></div><div class="slide-background future"></div></div><div class="slide-background past"><div class="slide-background present" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.09.06-20.38.21-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.12.14-12.51.12-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/12.12.14-15.42.41-ss.PNG);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.01.22-19.03.11-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.02.16-1.53.47-ss.png);"></div></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background past"></div><div class="slide-background present"></div><div class="slide-background future"></div><div class="slide-background future"><div class="slide-background present" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.03.23-0.49.54-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.03.25-11.53.35-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.03.26-1.53.53-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.03.27-19.22.56-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.05.01-17.58.18-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.05.30-16.03.40-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.05.29-19.04.26-ss.png);"></div><div class="slide-background future" data-background-transition="slide" style="background-image: url(https://michaelshaw.github.io/game_talk/screenshots/13.09.08-12.48.06-ss.png);"></div></div><div class="slide-background future"></div></div><div class="progress" style="display: block;"><span style="width: 1620px;"></span></div><aside class="controls" style="display: block;"><div class="navigate-left enabled"></div><div class="navigate-right enabled"></div><div class="navigate-up"></div><div class="navigate-down"></div></aside><div class="state-background"></div><div class="pause-overlay"></div></div>

    <script src="./Game development in Scala - Michael Shaw_files/head.min.js"></script>
    <script src="./Game development in Scala - Michael Shaw_files/reveal.min.js"></script>
    <script src="./Game development in Scala - Michael Shaw_files/highlight.pack.js"></script>
    <script src="./Game development in Scala - Michael Shaw_files/jquery-2.0.3.min.js"></script>

    <script>
      // insert sections based on screenshots
      var show_screenshots = true;

      var screenshots = [
        // post context
        '11.11.03-10.42.01-ss.png', // first screenshot
        '11.11.10-14.57.39-ss.png', // digging feet below ground (early)

        // after problem statement
        '11.12.21-23.52.25-ss.png', // broken serialization
        '11.12.07-17.49.18-ss.png', // broken water code
        '11.12.16-19.18.17-ss.png', // worst pathfinding
        '11.12.17-17.26.17-ss.png', // working pathfinding
        '11.11.19-14.21.13-ss.png', // crotch sword

        // after false starts
        '12.02.07-21.34.53-ss.png', // bloom
        '12.02.25-17.27.33-ss.png', // applying goblin skeleton to dwarf
        '12.06.28-00.00.00-ss.png', // nothing wrong, entities around a banner
        '12.06.29-23.24.02-ss.png', // early dismemberment
        '12.07.06-0.43.24-ss.png', // amputees standing around (from pretty stage)

        // after solution
        '12.09.06-20.38.21-ss.png', // orthographic
        '12.12.14-12.51.12-ss.png', // rigging done right
        '12.12.14-15.42.41-ss.PNG', // rigging done wrong

        '13.01.22-19.03.11-ss.png', // dk style cutaway
        '13.02.16-1.53.47-ss.png', // pixelated as all hell
        '13.03.23-0.49.54-ss.png', // goldrush palette
        '13.03.25-11.53.35-ss.png', // lich shot
        '13.03.26-1.53.53-ss.png', // rainy lich battle (with face obstruction)

        '13.03.27-19.22.56-ss.png', // lich raising dead
        '13.05.01-17.58.18-ss.png', // small vegetation square, grass + trees
        '13.05.30-16.03.40-ss.png', // first person, plants in fog
        '13.05.29-19.04.26-ss.png', // first person look over environment
        '13.09.08-12.48.06-ss.png'
      ]

      if(show_screenshots) {
        var ss = 0;
        $(".slides > section.screenshots").each(function(index) {
          var screenshot_count = parseInt($(this).attr("data-screenshot-count"));

          // ordering is wrong
          var parts = [];
          for(var i = 0; i < screenshot_count; i++) {
            if(ss < screenshots.length) {
              var screenshot = screenshots[ss]
              parts.push("<section class='screenshot' data-background-transition='slide' data-background='screenshots/" + screenshot + "' style='background: rgba(255,255,255,0.9)'></section>")
              ss += 1
            }
          }
          $("<section>" + parts.join(" ") + "</section>").insertAfter($(this));
        });
        console.log("screenshots left " + (screenshots.length - ss));
      }

      Reveal.initialize({
        history: true,
        transition: 'linear',

        overview: true,

        math: {
          // mathjax: 'http://cdn.mathjax.org/mathjax/latest/MathJax.js',
          config: 'TeX-AMS_HTML-full'
        }

        // dependencies: [
        //   { src: '../lib/js/classList.js' },
        //   { src: '../plugin/math/math.js', async: true }
        // ]
      });

      hljs.initHighlightingOnLoad();
    </script>

  

</body></html>