package main

import actors.threadpool.TimeUnit

class Game {

  private val maxFrameDuration = 8
  private val renderer = new GLRenderer()
  private val fpsManager = new FrameStatManager()

  // Constants
  private val MIN_SLEEP_TIME = 500
  private val MS_IN_NS = 1000000L
  private val SEC_IN_NS = 1000000000L

  def tick(delta: Long): Unit = {
    if (delta < 0) {
      throw new NegativeTimeException("The passed time delta to tick in Game was negative. This should not be able to happen...")
    }
    renderer.pollInput()
    update()
    renderer.render(delta)
    // Only needed, when vsync disabled and framerate capped
    if (renderer.vsync != 0 && maxFrameDuration != 0) {
      val frameDuration = maxFrameDuration * MS_IN_NS - System.nanoTime + delta
      if (frameDuration >= MIN_SLEEP_TIME) {
        TimeUnit.NANOSECONDS.sleep(frameDuration);
      }
    }
    fpsManager.tick(System.nanoTime - delta);
    println(fpsManager.getFrameDurationMs + "")
    if (!renderer.exit) {
      tick(System.nanoTime)
    }
  }

  def run(): Unit = {
    try {
      init();
      tick(System.nanoTime);
      renderer.close()
    } finally {
      renderer.finish()
    }
  }

  def init(): Unit = {
    renderer.init()
  }
  def update(): Unit = {

  }
}
